<!DOCTYPE html>
<html>
<head>
    <!-- http://coenraets.org/blog/2014/04/facebook-phonegap-cordova-without-plugin/ -->
    
    <meta http-equiv="Content-Security-Policy" content="child-src 'https://www.facebook.com/connect/login_success.html';"> 
    <meta charset="utf-8">
    <title>Facebook</title>
    <link rel="stylesheet" href="css/ratchet.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

	<div class="content content-padded">
	
	<button class="btn btn-block" onclick="login()">Login with Facebook</button>
	<hr/>
	
	<button class="btn btn-block" onclick="getInfo()">Get My Info</button>
	<p>Name: <span id="userName"></span></p>
	<img id="userPic"/>
	<hr/>
	
	<div id="home"></div>
	<div id="result_friends"></div>
 	<div id="fb-root"></div>
 	
 	<textarea id="Message" placeholder="Friends" rows="5"></textarea>
	<button class="btn btn-block" onclick="share()">Share</button>
	<hr/>
	
	<p>Complete Facebook Logout. After logging out, you'll have to login again and provide your Facebook credentials.</p>
	<button class="btn btn-block" onclick="logout()">Logout</button>
	<hr/>
	
	<button class="btn btn-block" onclick="readPermissions()">Read Permissions</button>
	
	<p>Revoke App Permissions. After revoking permissions, you'll have to grant permissions again when logging in.</p>
	<button class="btn btn-block" onclick="revoke()">Revoke Permissions</button>
	
	</div>

<!--cordova.js is automatically injected by the Cordova build process-->
<script src="cordova.js"></script>
<script src="js/openfb.js"></script>

<script>

     // Defaults to sessionStorage for storing the Facebook token
     openFB.init({appId: '1631549553795045'});

    //  To store the Facebook token in localStorage instead of sessionStorage
    //  openFB.init({appId: 'YOUR_FB_APP_ID', tokenStore: window.localStorage});
	
	 
    function sortMethod(a, b) {
         var x = a.name.toLowerCase();
         var y = b.name.toLowerCase();
         return ((x < y) ? -1 : ((x > y) ? 1 : 0));
    }
	
	
    function login() {
        openFB.login(
             function(response) {
                 if(response.status === 'connected') {
                     //alert('Facebook login succeeded, got access token: ' + response.authResponse.accessToken);
                     console.log('Facebook login succeeded');
                     getInfo();
                 } else {
                     console.log('Facebook login failed: ' + response.error);
                 }
             }, {scope: 'email'}); //'email, name, read_stream, publish_actions, user_friends'
    }

       
    function getInfo() {
        openFB.api({
            path: '/me',
            success: function(data) {
                console.log(JSON.stringify(data));
                document.getElementById("userName").innerHTML = data.name;
                //document.getElementById("email").innerHTML = data.email;
                document.getElementById("userPic").src = 'http://graph.facebook.com/' + data.id + '/picture?type=small';
            	//getEmail(data.id);
            	//document.getElementById('Message').value = data.user_friends;
            	
            	openFB.api({
			        path: '/me/picture',
			        params: {redirect:false},
			        success: function(data) {
			          document.getElementById('Message').value = data.data.url;
			        },
			        error: function(err) {console.log(err);}
			    });
			    
			     // get friends
                 openFB.api({
                 path: '/me/friends?limit=99', 
                 params: {redirect:false},
			     success: function(response) {
			     	 console.log(JSON.stringify(response));
                     var result_holder = document.getElementById('result_friends');
                     var friend_data = response.data.sort(sortMethod);
                     var results = '';
                     for (var i = 0; i < friend_data.length; i++) {
                         results += '<div><img src="https://graph.facebook.com/' + friend_data[i].id + '/picture">' + friend_data[i].name + '</div>';
                     }
                     result_holder.innerHTML = '<h2>Result list of your friends:</h2>' + results;
                 	},
			        error: function(err) {console.log(err);}
			    });

			    
			    //openFB.api({
			    //    path: '/me/friends',
			    //    params: {redirect:false},
			    //    success: function(data) {
			    //      console.log(JSON.stringify(data));
			    //    },
			    //    error: function(err) {console.log(err);}
			    //});
			    
			    
            },
            error: errorHandler});
    }
	
	
	function getEmail(mytoken){
            var url = "https://graph.facebook.com/me/home?access_token=" + mytoken;
            var html = "<ul>";
            $.getJSON(url, function(json){
                //console.log(json);
                $.each(json.data, function(i,fb){
                    html += "<li>" + fb.id + "</li>";
                });
            });
            html += "</ul>";
            alert('getEmail:' + html);
			document.getElementById('home').innerHTML = html;
     }
    
	
	//function getFriends() {
	//	openFB.api({
    //        path: '/me/friends',
    //        success: function(data) {
    //            console.log(JSON.stringify(data));
    //            document.getElementById("userName").innerHTML = data.name;
    //            document.getElementById("userPic").src = 'http://graph.facebook.com/' + data.id + '/picture?type=small';
    //        },
    //        error: errorHandler});
	//}
	
	
    function share() {
        openFB.api({
            method: 'POST',
            path: '/me/feed',
            params: {
                message: document.getElementById('Message').value || 'Testing Facebook APIs'
            },
            success: function() {
                alert('the item was posted on Facebook');
            },
            error: errorHandler});
    }

    function readPermissions() {
        openFB.api({
            method: 'GET',
            path: '/me/permissions',
            success: function(result) {
                alert(JSON.stringify(result.data));
            },
            error: errorHandler
        });
    }

    function revoke() {
        openFB.revokePermissions(
                function() {
                    alert('Permissions revoked');
                },
                errorHandler);
    }

    function logout() {
        openFB.logout(
                function() {
                    alert('Logout successful');
                },
                errorHandler);
    }

    function errorHandler(error) {
        alert(error.message);
    }

</script>
</body>
</html>
